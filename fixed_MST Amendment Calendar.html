<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MST Amendment Calendar — Clean + Flyout Filters</title>

  <!-- FullCalendar CSS -->
  <link href="libs/fullcalendar.min.css" rel="stylesheet" />
  
    <!-- Local libs (keep order) -->
   <script src="libs/xlsx.full.min.js"></script>
  <script src="libs/FileSaver.min.js"></script>
  <script src="libs/index.global.min.js"></script>
  <script src="libs/exceljs.min.js"></script>
  <script src="libs/chart.umd.min.js"></script>
  
  <!-- Your variables + helpers -->
  <script src="libs/mst-variables.js"></script>
  <script src="libs/mst-stdjobs.js"></script>
    <script src="libs/mst-core-utils.js"></script>
  <script src="libs/mst-editor-logic.js"></script>
      <script src="libs/FileUpload.js"></script>
    <script src="libs/FileExport.js"></script>
  
  <!-- shared CSS -->
  <link href="libs/mst-styles.css" rel="stylesheet" />

  <style>
    /******************************************************************
     * FILTER FLYOUT + OVERLAY
     ******************************************************************/
    /* Dim page */
    #filterOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1100;
    }
    #filterOverlay.active { display: block; }

    /* Slide-out panel */
    #filterPanel {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      max-width: 85vw;
      height: 100%;
      background: #fff;
      border-left: 1px solid #ddd;
      box-shadow: -4px 0 14px rgba(0,0,0,0.12);
      z-index: 1200;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      display: flex;
      flex-direction: column;
    }
    #filterOverlay.active #filterPanel {
      transform: translateX(0);
    }

    #filterPanelHeader {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #filterPanelHeader h3 {
      margin: 0;
      font-size: 16px;
    }
    #filterPanelBody {
      padding: 14px 16px 100px 16px;
      overflow-y: auto;
      flex: 1;
    }
    .filter-field {
      margin-bottom: 12px;
    }
    .filter-field label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: #444;
      margin-bottom: 4px;
    }
    .filter-field select {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
    }
    #filterPanelFooter {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
      background: #fafafa;
    }
    #openFilterBtn {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    #applyFiltersBtn {
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    #resetFiltersBtn {
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    #closeFilterBtn {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      color: #444;
    }
  </style>
</head>
<body>
  <!-- =========================
       LEFT SIDEBAR (Editor)
  ========================== -->
  <div id="sidebar">
    <h2>MST Details</h2>

    <div id="detailsIntro">
      <p>Select a <strong>GREEN</strong> MST in the calendar to view or edit details.</p>
      <p>Then use <em>Save Changes</em> or <em>Revert This MST</em>.</p>
    </div>

    <div id="editForm" style="display:none;">

      <div class="section-title">Identification</div>

      <div class="field-block">
        <label>Equipment Number</label>
        <input id="equipDisplay" disabled />
      </div>

      <div class="field-block">
        <label>MST Task Number</label>
        <input id="taskDisplay" disabled />
      </div>

      <!-- Hidden MST ID (CONCAT) -->
      <div class="field-block" style="display:none;">
        <label>MST ID (CONCAT)</label>
        <input id="mstIdDisplay" disabled />
      </div>

      <div class="field-block">
        <label>MST Description 1</label>
        <input id="desc1Display" disabled />
      </div>

      <div class="section-title">Scheduling</div>
	  
<div class="field-block">
  <label for="lastDatePerf">Last Performed Date</label>
  <input type="date" id="lastDatePerf" disabled />
</div>


      <div class="field-block">
        <label for="lastDateInput">Last Scheduled Date</label>
        <input type="date" id="lastDateInput" />
      </div>
	  
<div class="field-block">
  <label for="nextDateCalc">Next Scheduled Date (Calculated)</label>
  <input type="date" id="nextDateCalc" disabled />
</div>
	  
      <div class="field-block">
        <label for="freqInput">Frequency (days)</label>
        <input type="number" id="freqInput" min="0" />
      </div>

      <div class="field-block">
        <label for="desc2Input">Description 2</label>
        <input type="text" id="desc2Input" />
      </div>

      <div class="section-title">Work / Ownership</div>

      <div class="field-block">
        <label for="wgInput">Work Group Code</label>
        <input type="text" id="wgInput" />
      </div>

      <div class="field-block">
        <label for="jobDescCodeInput">Job Description Code</label>
        <select id="jobDescCodeInput" style="width:100%;"></select>
      </div>

      <div class="section-title">Requirements</div>

      <div class="field-block">
        <label for="unitsRequiredInput" id="unitsRequiredLabel">Units Required</label>
        <input type="number" id="unitsRequiredInput" min="0" />
      </div>

      <div class="field-block">
        <label for="mileageFromInput">Segment Mileage From (for Linear Assets: Track ID, Boundary etc)</label>
        <input type="number" id="mileageFromInput" min="0" />
      </div>

      <div class="field-block">
        <label for="mileageToInput">Segment Mileage To (for Linear Assets: Track ID, Boundary etc)</label>
        <input type="number" id="mileageToInput" min="0" />
      </div>

      <div class="section-title">Protection</div>

      <div class="field-block">
        <label for="protTypeInput">Protection Type</label>
        <select id="protTypeInput" style="width:100%;"></select>
      </div>

      <div class="field-block">
        <label for="protMethodInput">Protection Method</label>
        <select id="protMethodInput" style="width:100%;"></select>
      </div>

      <button id="saveBtn" style="margin-top:15px;">Save Changes</button>

      <button id="deactivateBtn" style="
        background:#111;
        color:white;
        border:none;
        border-radius:6px;
        padding:8px 14px;
        font-weight:bold;
        margin-top:10px;
        cursor:pointer;
        width:100%;
      ">
        Deactivate MST
      </button>

      <button id="revertBtn" style="margin-top:10px;">Revert This MST</button>
    </div>
  </div>

  <!-- =========================
       RIGHT FILTER OVERLAY + PANEL
  ========================== -->
  <div id="filterOverlay">
    <aside id="filterPanel" aria-label="Filter MSTs">
      <div id="filterPanelHeader">
        <h3>Filter MSTs</h3>
        <button id="closeFilterBtn" title="Close">✕</button>
      </div>
	  
      <div id="filterPanelBody">
       <!-- Work Group -->
<div class="filter-field">
  <label for="filterWorkGroup"><strong>Work Group Code</strong></label>
  <select id="filterWorkGroup"><option value="">(All)</option></select>
</div>

<!-- Asset Description 1 -->
<div class="filter-field">
  <label for="filterEquipDesc1"><strong>Asset Description 1</strong></label>
  <select id="filterEquipDesc1"><option value="">(All)</option></select>
</div>

<!-- Job Description -->
<div class="filter-field">
  <label for="filterJobDesc"><strong>Job Description Code</strong></label>
  <select id="filterJobDesc"><option value="">(All)</option></select>
</div>

<!-- MST Description 1 -->
<div class="filter-field">
  <label for="filterDesc1"><strong>MST Description 1</strong></label>
  <select id="filterDesc1"><option value="">(All)</option></select>
</div>

<!-- MST Description 2 -->
<div class="filter-field">
  <label for="filterDesc2"><strong>MST Description 2</strong></label>
  <select id="filterDesc2"><option value="">(All)</option></select>
</div>

<!-- Protection Type -->
<div class="filter-field">
  <label for="filterProtType"><strong>Protection Type</strong></label>
  <select id="filterProtType"><option value="">(All)</option></select>
</div>

<!-- Protection Method -->
<div class="filter-field">
  <label for="filterProtMethod"><strong>Protection Method</strong></label>
  <select id="filterProtMethod"><option value="">(All)</option></select>
</div>



		
      </div>
      <div id="filterPanelFooter">
        <button id="applyFiltersBtn">Apply</button>
        <button id="resetFiltersBtn">Reset</button>
      </div>
    </aside>
  </div>



  <!-- =========================
       CALENDAR COLUMN
  ========================== -->
  <div id="calendar">
    <h1 style="text-align:center;">MST Amendment Calendar</h1>
    <div style="text-align:center; margin:4px 0 8px 0;">
      <div id="downloadDateDisplay" style="font-weight:bold;">Download Date: —</div>
      <div
        id="downloadDateWarning"
        style="color:#b45309; font-weight:bold; display:none; max-width:720px; margin:6px auto 0 auto;"
      ></div>
    </div>
    <p style="text-align:center;">
      Upload MST Excel/CSV.<br />
      Green = current instance (click to edit). Amber = next due. Red = following due.<br />
      You can drag the green instance to shift dates. Export changes when done or reset all.
    </p>
	
<div id="batchInputContainer" style="margin-top: 10px; margin-bottom: 10px; text-align:center;">
<input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
  <label for="batchNumber" style="font-weight:bold;">Batch Number:</label>
  <input 
    type="text" 
    id="batchNumber" 
    placeholder="LANDC....." 
    style="padding:6px 10px; margin-left:8px; border:1px solid #ccc; border-radius:4px; width:180px;"
  />
        <button id="exportBtn">Export MST Changes</button>
</div>

    <div id="controls">
      <button id="resetAllBtn" style="background:#ef4444; color:white;">Reset All Changes</button>
      <button id="openFilterBtn">⚙️ Filters</button>
	  <button id="openGotoBtn">Go to MST</button>
	  <button id="openResourceBtn" class="topbar-btn">Planned Hours Graph</button>
      <span id="changeCount" style="font-weight:bold; margin-left:8px;"></span>
      <div id="loading">Loading MSTs...</div>
    </div>

    <button id="newMSTBtn" 
	onclick="MST.Editor.openNewMSTModal()"
	style="
      background:#2C3E50;
      color:white;
      border:none;
      border-radius:6px;
      padding:8px 16px;
      font-weight:bold;
      margin-bottom:10px;
      cursor:pointer;
    ">
      + New MST
    </button>

    <div id="calendarEl"></div>
  </div>
  
  <!-- =========================
       Floating Resource
  ========================== -->
  <div id="resourceFloatPanel">
  <div id="resourceFloatHeader">
    <span>Planned Hours (6 weeks)</span>
    <button id="closeResourceFloat">✕</button>
  </div>

  <div id="resourceFloatControls">
    <button id="prevWindowBtn">◀</button>
    <span id="resourceRangeLabel"></span>
    <button id="nextWindowBtn">▶</button>
  </div>

  <div id="resourceTotalHours" style="font-weight:bold; text-align:center; margin:6px 0;">Total: 0h</div>

  <canvas id="plannedHoursChart" width="350" height="220"></canvas>
</div>

<!-- =========================
       NEW MST MODAL (Updated)
  ========================== -->
<div id="newMSTModal" style="
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  justify-content:center;
  align-items:center;
  pointer-events:auto;
">
  <div id="newMSTBox" style="
    background:#fff;
    width:75%;
    max-width:900px;
    max-height:90%;
    overflow-y:auto;
    padding:30px;
    border-radius:12px;
    box-shadow:0 4px 20px rgba(0,0,0,0.3);
    pointer-events:auto;
  ">
    <h2 style="text-align:center;">Create New MST</h2>
    <p style="text-align:center;">
      Fields marked <span style="color:red">*</span> are mandatory.
    </p>

  <div id="newMSTForm">
  <!-- Row 1 -->
 <label>
  <span class="label-title">
    Equipment Number <span class="required-star">*</span>
  </span>
  <input id="newEquipNo" required />
  <small id="newEquipDesc" class="muted-helper"></small>
</label>

<label>
   <span class="label-title">
    Standard Job Number <span class="required-star">*</span>
  </span>
    <input id="newStdJobNo" required />
    <small><a href="https://networkrail.sharepoint.com/:x:/r/sites/asd/_layouts/15/Doc.aspx?sourcedoc=%7B62BADB1E-7450-46C4-A0C1-353E38D2AA72%7D&file=Standard%20Job%20List.xls&action=default&mobileredirect=true&DefaultItemOpen=1%3Fweb%3D1" id="stdJobListLink" target="_blank">View Standard Job List</a></small>
  </label>

  <!-- Row 2 -->
 <label>
  <span class="label-title">
    MST Description 1 <span class="required-star">*</span>
  </span>
    <input id="newDesc1" readonly />
  </label>

  <label>MST Description 2
    <input id="newDesc2" maxlength="40" />
  </label>
  
  <label>
  <span class="label-title">
    WorkGroup <span class="required-star">*</span>
  </span>
    <input id="newWorkGroup" required></select>
	</label>
  <!-- Row 3 -->
   <label>
  <span class="label-title">
    Job Description Code <span class="required-star">*</span>
  </span>
    <select id="newJobCode" required></select>
  </label>

   <label>
  <span class="label-title">
    Frequency (Days) <span class="required-star">*</span>
  </span>
    <input id="newFreq" type="number" min="1" required />
  </label>

  <!-- Row 4 -->
   <label>
  <span class="label-title">
    Last Scheduled Date <span class="required-star">*</span>
  </span>
    <input id="newLastDate" type="date" required />
  </label>

  <label>
  <span class="label-title">
    Units Required <span class="required-star">*</span>
  </span>
    <input id="newUnits" type="number" required />
  </label>

  <!-- Row 5 -->
  <label>Unit of Measure
    <input id="newUnitMeasure" readonly />
  </label>

  <label>Mileage From
    <input id="newFrom" />
  </label>

  <!-- Row 6 -->
  <label>Mileage To
    <input id="newTo" />
  </label>

  <label>
  <span class="label-title">
    Protection Type <span class="required-star">*</span>
  </span>
    <select id="newProtType" required></select>
  </label>

  <!-- Row 7 -->
   <label>
  <span class="label-title">
    Protection Method <span class="required-star">*</span>
  </span>
    <select id="newProtMethod" required></select>
  </label>
</div>


    <div style="text-align:center; margin-top:20px;">
      <button id="addMSTBtn" style="background:#10b981;color:white;border:none;padding:8px 20px;border-radius:6px;">
        Add MST
      </button>
      <button id="cancelMSTBtn" style="background:#ef4444;color:white;border:none;padding:8px 20px;border-radius:6px;margin-left:10px;">
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- =========================
     GO TO MST OVERLAY + PANEL
========================== -->
<div id="gotoOverlay">
  <aside id="gotoPanel" aria-label="Go to MST">
    <div id="gotoHeader">
      <h3>Go to MST</h3>
      <button id="closeGotoBtn" title="Close">✕</button>
    </div>

    <div id="gotoBody">
      <div class="goto-field">
        <label for="gotoEquip"><strong>Equipment Number</strong></label>
 <input type="text" id="gotoEquip" list="equipList" placeholder="Enter Equipment No" />
<datalist id="equipList"></datalist>

<small id="equipDescPreview" 
       style="display:block; margin-top:4px; font-size:13px; font-weight:bold; color:#333;">
</small>

      </div>
     <div class="goto-field">
        <label for="gotoTask"><strong>Task Number</strong></label>
        <input id="gotoTask" placeholder="e.g. 001" />
      </div>
      <button id="gotoSearchBtn" class="btn-primary" style="margin:8px 0 12px;">Search</button>

      <div id="gotoResults" style="display:none;">
        <table class="goto-table">
          <thead>
            <tr><th>Task No</th><th>MST Description 1</th></tr>
          </thead>
          <tbody id="gotoResultsBody"></tbody>
        </table>
      </div>
    </div>

    <div id="gotoFooter">
      <button id="closeGotoBtn2">Close</button>
    </div>
  </aside>
</div>

  <!-- =======================================================
     WORK GROUP SELECT MODAL (Shown after file upload)
======================================================= -->
<div id="wgSelectModal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:99999;
  justify-content:center; align-items:center; pointer-events:auto;">
  
  <div style="
    background:white; padding:25px; border-radius:10px;
    min-width:420px; max-width:600px; pointer-events:auto;">

    <h3>Select Work Group Set Description</h3>
    <p>Please choose which MST set you want to load into the calendar.</p>

  <select id="wgSelectDropdown" multiple size="8" style="
  width:100%; padding:8px; margin-top:12px; border:1px solid #bbb; border-radius:6px;">
</select>
<p style="font-size:12px; color:#444; margin-top:5px;">
Hold <strong>Ctrl</strong> (or <strong>Cmd</strong> on Mac) to select multiple
</p>


    <div style="text-align:right; margin-top:18px;">
      <button id="wgSelectConfirm" style="padding:6px 18px; background:#10b981; color:white; border:none; border-radius:6px;">
        Load MSTs
      </button>
    </div>

  </div>
</div>

  <!-- =========================
       PAGE SCRIPT
  ========================== -->
  <script src="libs/Resources.js"></script>
  <script src="libs/MST-views.js"></script>
  <script>
    /******************************************************************
     * STATE
     ******************************************************************/

    window.futureEventsMap = {};  // mstId -> [EventApi, EventApi]
    window.originalProps   = {};  // mstId -> source row (snapshot)
    window.changes            = {};  // mstId -> export deltas
    window.originalRows       = [];  // raw uploaded rows

// ================================
// NEW MST MODAL LOGIC
// ================================

const newMSTBtn      = document.getElementById("newMSTBtn");
const newMSTModal    = document.getElementById("newMSTModal");
const addMSTBtn      = document.getElementById("addMSTBtn");
const cancelMSTBtn   = document.getElementById("cancelMSTBtn");

// Add MST
addMSTBtn.addEventListener("click", () => MST.Editor.addNewMST());

  </script>


</body>
</html>
