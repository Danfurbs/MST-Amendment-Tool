<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MST Amendment Calendar</title>

  <!-- FullCalendar CSS -->
  <link href="libs/fullcalendar.min.css" rel="stylesheet" />
  
    <!-- Local libs (keep order) -->
  <!-- use version 0.20.3 -->
<script type="text/javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="libs/FileSaver.min.js"></script>
  <script src="libs/index.global.min.js"></script>
  <script src="libs/exceljs.min.js"></script>
  <script src="libs/chart.umd.min.js"></script>
  
  <!-- Your variables + helpers -->
  <script src="libs/mst-variables.js"></script>
  <script src="libs/mst-stdjobs.js"></script>
  <script src="libs/mst-core-utils.js"></script>
  <script src="libs/mst-error-flags.js"></script>
  <script src="libs/mst-editor-logic.js"></script>
  <script src="libs/FileUpload.js"></script>
  <script src="libs/FileExport.js"></script>
  
  <!-- shared CSS -->
  <link href="libs/mst-styles.css" rel="stylesheet" />

  <style>
    /******************************************************************
     * TOP BAR LAYOUT REFINEMENT
     ******************************************************************/
    .page-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 37px 14px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
      margin-bottom: 14px;
    }
    .header-top {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: baseline;
      justify-content: space-between;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-text h1 {
      margin: 0;
      font-size: 32px;
      letter-spacing: 0.15px;
      color: #0f172a;
    }
    .download-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin: 2px 0 0 0;
      font-size: 13px;
      line-height: 1.3;
    }
    #downloadDateDisplay {
      font-weight: 700;
      color: #111827;
    }
    #downloadDateWarning {
      color: #b45309;
      font-weight: 700;
      max-width: 720px;
    }
    .collapse-toggle {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #0f172a;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .collapse-toggle:hover {
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }
    .page-header.collapsed {
      padding: 12px;
      gap: 6px;
    }
    .page-header.collapsed .download-meta,
    .page-header.collapsed .header-bottom {
      display: none;
    }
    .header-bottom {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
      grid-auto-rows: 1fr;
      align-items: stretch;
    }
    .help-box {
      display: flex;
      flex-direction: column;
      height: 100%;
      margin-top: 6px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      color: #111827;
      font-size: 13px;
      line-height: 1.35;
    }
    .help-box p {
      margin: 0 0 6px 0;
      font-weight: 700;
      font-size: 13px;
    }
    .help-box ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 4px;
    }
    .help-box li {
      list-style: disc;
      font-weight: 600;
      color: #0f172a;
      font-size: 12.5px;
    }
    .upload-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 7px 10px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
      height: 100%;
      justify-content: space-between;
    }
    .upload-card .label {
      font-weight: 700;
      color: #0f172a;
      font-size: 12px;
    }
    .upload-controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .file-upload-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #1e293b;
      color: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      font-size: 12.5px;
    }
    .file-upload-btn.disabled {
      background: #94a3b8;
      cursor: not-allowed;
      opacity: 0.9;
    }
    .file-upload-btn input[type="file"] {
      display: none;
    }
    .batch-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .batch-field label {
      font-size: 11.5px;
      font-weight: 700;
      color: #334155;
    }
    .batch-field input {
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 13px;
    }
    #exportBtn,
    #exportBtnCompact {
      background: #0ea5e9;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      padding: 8px 10px;
      align-self: flex-start;
      box-shadow: 0 2px 10px rgba(14, 165, 233, 0.25);
      font-size: 12.5px;
    }
    .action-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 10px;
    }
    .action-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .action-meta {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }
    .action-status {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .collapsed-controls {
      display: none;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      padding-left: 10px;
      border-left: 1px solid #e2e8f0;
    }
    .action-bar.header-collapsed .collapsed-controls {
      display: flex;
    }
    .compact-batch-row {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 240px;
    }
    .compact-batch-row label {
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
      white-space: nowrap;
    }
    .compact-batch {
      min-width: 200px;
    }
    #batchNumberCompact {
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 13px;
    }
    .primary-action-btn {
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.05s ease, box-shadow 0.1s ease;
    }
    .primary-action-btn:hover {
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
    }
    .primary-action-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.08);
    }
    .error-summary {
      margin-top: 12px;
      padding: 10px 12px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 10px;
      color: #7c2d12;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    }
    .error-summary ul {
      margin: 6px 0 0 18px;
      padding: 0;
      display: grid;
      gap: 4px;
    }
    .error-summary li {
      list-style: disc;
    }
    .error-summary .link-btn {
      margin-left: 8px;
      border: none;
      background: none;
      color: #b45309;
      text-decoration: underline;
      font-weight: 700;
      cursor: pointer;
      padding: 0;
    }
    .error-summary .link-btn:hover {
      color: #92400e;
    }
    .error-summary .mst-link {
      font-weight: 700;
      padding-left: 0;
    }
    .error-summary .error-details {
      margin-top: 10px;
      padding: 10px 12px;
      background: #fff;
      border: 1px solid #fed7aa;
      border-radius: 8px;
      color: #7c2d12;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }
    .error-summary .error-details h4 {
      margin: 0 0 6px 0;
      font-size: 13px;
    }
    .error-summary .error-details ul {
      margin: 0 0 0 18px;
      gap: 2px;
    }
      .action-meta {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 12px;
        flex-wrap: wrap;
        font-weight: 700;
        color: #1f2937;
      }
    #changeCount {
      font-weight: 700;
      color: #0f172a;
    }
    #controls {
      text-align: initial;
      margin-bottom: 0;
    }

    /* FullCalendar spacing */
    #calendarEl .fc-header-toolbar {
      margin-top: 8px;
      padding-top: 6px;
    }

    /******************************************************************
     * FILTER FLYOUT + OVERLAY
     ******************************************************************/
    /* Dim page */
    #filterOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1100;
    }
    #filterOverlay.active { display: block; }

    /* Slide-out panel */
    #filterPanel {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      max-width: 85vw;
      height: 100%;
      background: #fff;
      border-left: 1px solid #ddd;
      box-shadow: -4px 0 14px rgba(0,0,0,0.12);
      z-index: 1200;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      display: flex;
      flex-direction: column;
    }
    #filterOverlay.active #filterPanel {
      transform: translateX(0);
    }

    #filterPanelHeader {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #filterPanelHeader h3 {
      margin: 0;
      font-size: 16px;
    }
    #filterPanelBody {
      padding: 14px 16px 100px 16px;
      overflow-y: auto;
      flex: 1;
    }
    .filter-field {
      margin-bottom: 12px;
    }
    .filter-field label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: #444;
      margin-bottom: 4px;
    }
    .filter-field select {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
    }
    #filterPanelFooter {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
      background: #fafafa;
    }
    #openFilterBtn {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    #applyFiltersBtn {
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    #resetFiltersBtn {
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    #closeFilterBtn {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      color: #444;
    }

    /* SQL reference block */
    .sql-callout {
      margin-top: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.05);
    }
    .sql-callout summary {
      font-weight: 800;
      font-size: 14px;
      color: #0f172a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sql-callout summary:hover {
      color: #0b2948;
    }
    .sql-callout p {
      margin: 8px 0 10px 0;
      color: #1f2937;
      font-weight: 600;
      line-height: 1.45;
    }
    .sql-code-block {
      margin: 0;
      padding: 12px;
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 8px;
      overflow-x: auto;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 12.5px;
      line-height: 1.4;
      white-space: pre;
    }
  </style>
</head>
<body>
  <!-- =========================
       LEFT SIDEBAR (Editor)
  ========================== -->
  <div id="sidebar">
    <h2>MST Details</h2>
    <div id="tvActions" class="tv-actions">
      <div id="tvAppliedLabel" class="tv-applied-label">TV Applied</div>
      <div class="tv-buttons">
        <button id="applyTvBtn" class="tv-btn" type="button">Apply TV</button>
        <button id="editTvBtn" class="tv-btn" type="button">Edit TV</button>
        <button id="removeTvBtn" class="tv-btn tv-remove-btn" type="button">Remove TV</button>
      </div>
    </div>
    <div id="tvForm" class="tv-form">
      <div class="field-block">
        <label for="tvReferenceInput">TV Reference</label>
        <input id="tvReferenceInput" type="text" />
      </div>
      <div class="field-block">
        <label for="tvExpiryInput">Expiry Date</label>
        <input id="tvExpiryInput" type="date" />
      </div>
      <div class="tv-form-actions">
        <button id="saveTvBtn" class="tv-btn" type="button">Save TV</button>
        <button id="cancelTvBtn" class="tv-btn tv-secondary-btn" type="button">Cancel</button>
      </div>
    </div>

    <div id="detailsIntro">
      <p>Select a <strong>GREEN</strong> MST (light blue if it has a TV Reference) in the calendar to view or edit details.</p>
      <p>Then use <em>Save Changes</em> or <em>Revert This MST</em>.</p>
    </div>

    <div id="editForm" style="display:none;">

      <div class="section-title">Identification</div>

      <div class="field-block">
        <label>Equipment Number</label>
        <input id="equipDisplay" disabled />
      </div>

      <div class="field-block">
        <label>MST Task Number</label>
        <input id="taskDisplay" disabled />
      </div>

      <!-- Hidden MST ID (CONCAT) -->
      <div class="field-block" style="display:none;">
        <label>MST ID (CONCAT)</label>
        <input id="mstIdDisplay" disabled />
      </div>

      <div class="field-block">
        <label>MST Description 1</label>
        <input id="desc1Display" disabled />
      </div>

      <div class="section-title">Scheduling</div>
	  
<div class="field-block">
  <label for="lastDatePerf">Last Performed Date</label>
  <input type="date" id="lastDatePerf" disabled />
</div>


      <div class="field-block">
        <label for="lastDateInput">Last Scheduled Date</label>
        <input type="date" id="lastDateInput" />
      </div>
	  
<div class="field-block">
  <label for="nextDateCalc">Next Scheduled Date (Calculated)</label>
  <input type="date" id="nextDateCalc" disabled />
</div>
	  
        <div class="field-block">
          <label for="freqInput">Frequency (days)</label>
          <input type="number" id="freqInput" min="0" />
        </div>

        <div class="field-block">
          <label for="desc2Input">Description 2</label>
          <input type="text" id="desc2Input" maxlength="45" />
          <div class="char-counter" id="desc2Counter">0/45</div>
        </div>

      <div class="section-title">Work / Ownership</div>

      <div class="field-block">
        <label for="wgInput">Work Group Code</label>
        <input type="text" id="wgInput" />
      </div>

      <div class="field-block">
        <label for="jobDescCodeInput">Job Description Code</label>
        <select id="jobDescCodeInput" style="width:100%;"></select>
      </div>

      <div class="section-title">Requirements</div>

      <div class="field-block">
        <label for="unitsRequiredInput" id="unitsRequiredLabel">Units Required</label>
        <input type="number" id="unitsRequiredInput" min="0" />
      </div>

      <div class="field-block">
        <label for="mileageFromInput">Segment Mileage From (for Linear Assets: Track ID, Boundary etc)</label>
        <input type="number" id="mileageFromInput" min="0" />
      </div>

      <div class="field-block">
        <label for="mileageToInput">Segment Mileage To (for Linear Assets: Track ID, Boundary etc)</label>
        <input type="number" id="mileageToInput" min="0" />
      </div>

      <div class="section-title">Protection</div>

      <div class="field-block">
        <label for="protTypeInput">Protection Type</label>
        <select id="protTypeInput" style="width:100%;"></select>
      </div>

      <div class="field-block">
        <label for="protMethodInput">Protection Method</label>
        <select id="protMethodInput" style="width:100%;"></select>
      </div>

      <div class="field-block" style="margin-top:8px;">
        <label for="allowMultipleInput" style="display:block; font-weight:bold; margin-bottom:6px;">Allow multiple Work Orders</label>
        <input type="checkbox" id="allowMultipleInput" />
        <div class="muted-helper" style="margin-top:4px;">
          For &lt;14 Day MSTs and allows the next instance of the MST to be generated before the previous has been closed.
        </div>
      </div>

      <button id="saveBtn" style="margin-top:15px;">Save Changes</button>

      <button id="deactivateBtn" style="
        background:#111;
        color:white;
        border:none;
        border-radius:6px;
        padding:8px 14px;
        font-weight:bold;
        margin-top:10px;
        cursor:pointer;
        width:100%;
      ">
        Deactivate MST
      </button>

      <button id="revertBtn" style="margin-top:10px;">Revert This MST</button>
    </div>
  </div>

  <!-- =========================
       RIGHT FILTER OVERLAY + PANEL
  ========================== -->
  <div id="filterOverlay">
    <aside id="filterPanel" aria-label="Filter MSTs">
      <div id="filterPanelHeader">
        <h3>Filter MSTs</h3>
        <button id="closeFilterBtn" title="Close">‚úï</button>
      </div>
	  
      <div id="filterPanelBody">
       <!-- Work Group -->
<div class="filter-field">
  <label for="filterWorkGroup"><strong>Work Group Code</strong></label>
  <select id="filterWorkGroup"><option value="">(All)</option></select>
</div>

<!-- Asset Description 1 -->
<div class="filter-field">
  <label for="filterEquipDesc1"><strong>Asset Description 1</strong></label>
  <select id="filterEquipDesc1"><option value="">(All)</option></select>
</div>

<!-- Job Description -->
<div class="filter-field">
  <label for="filterJobDesc"><strong>Job Description Code</strong></label>
  <select id="filterJobDesc"><option value="">(All)</option></select>
</div>

<!-- MST Description 1 -->
<div class="filter-field">
  <label for="filterDesc1"><strong>MST Description 1</strong></label>
  <select id="filterDesc1"><option value="">(All)</option></select>
</div>

<!-- MST Description 2 -->
<div class="filter-field">
  <label for="filterDesc2"><strong>MST Description 2</strong></label>
  <select id="filterDesc2"><option value="">(All)</option></select>
</div>

<!-- Protection Type -->
<div class="filter-field">
  <label for="filterProtType"><strong>Protection Type</strong></label>
  <select id="filterProtType"><option value="">(All)</option></select>
</div>

<!-- Protection Method -->
<div class="filter-field">
  <label for="filterProtMethod"><strong>Protection Method</strong></label>
  <select id="filterProtMethod"><option value="">(All)</option></select>
</div>



		
      </div>
      <div id="filterPanelFooter">
        <button id="applyFiltersBtn">Apply</button>
        <button id="resetFiltersBtn">Reset</button>
      </div>
    </aside>
  </div>



  <!-- =========================
       CALENDAR COLUMN
  ========================== -->
  <div id="calendar">
    <div class="page-header">
      <div class="header-top">
        <div class="header-text">
          <h1>MST Amendment Calendar</h1>
          <div class="download-meta">
            <div id="downloadDateDisplay">Download Date: ‚Äî</div>
            <div id="downloadDateWarning" style="display:none;"></div>
          </div>
        </div>
        <div class="header-actions">
          <button id="toggleHeaderBtn" class="collapse-toggle" aria-expanded="true">
            Hide instructions
            <span aria-hidden="true">‚ñ≤</span>
          </button>
        </div>
      </div>
      <div class="header-bottom">
        <div class="help-box">
          <p><strong>How to use this tool:</strong></p>
            <ul>
              <li>üì§ <strong>Upload</strong> the MST download using the file picker below.</li>
            <li><span style="color:#10b981;font-weight:bold;">üü© Green</span> = current MST ‚Äî click to view or edit details.</li>
            <li><span style="color:#f59e0b;font-weight:bold;">üüß Amber</span> = next due date.</li>
            <li><span style="color:#ef4444;font-weight:bold;">üü• Red</span> = following due date.</li>
            <li>‚û°Ô∏è <strong>Drag</strong> green MSTs to move them to a new date.</li>
            <li>üíæ When finished, click <strong>Export MST Changes</strong> to save your amendments.</li>
            <li>üîÑ Use <strong>Reset All Changes</strong> to discard unsaved edits.</li>
          </ul>
        </div>
        <div class="upload-card">
          <div class="label">Upload MST Download</div>
            <div class="upload-controls">
              <label class="file-upload-btn" for="fileInput">
                <span class="file-upload-label-text">üìÑ Choose file</span>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
              </label>
              <div class="batch-field">
                <label for="batchNumber">Batch Number</label>
                <input type="text" id="batchNumber" placeholder="LANDC....." />
              </div>
            </div>
            <div class="muted-helper">Upload the latest MST download as an Excel or CSV file.</div>
          <button id="exportBtn">Export MST Changes</button>
        </div>
      </div>
    </div>

    <div id="controls" class="action-bar">
      <div class="action-buttons">
        <button id="resetAllBtn" style="background:#ef4444; color:white;">Reset All Changes</button>
        <button id="openFilterBtn">‚öôÔ∏è Filters</button>
        <button id="openGotoBtn" class="primary-action-btn">Go to MST</button>
        <button id="openResourceBtn" class="primary-action-btn">Planned Hours Graph</button>
        <button id="newMSTBtn" class="primary-action-btn">+ New MST</button>
      </div>
      <div class="action-meta">
        <div class="action-status">
          <span id="changeCount"></span>
          <div id="loading">Loading MSTs...</div>
        </div>
        <div id="collapsedHeaderControls" class="collapsed-controls">
          <div class="compact-batch-row">
            <label for="batchNumberCompact">Batch Number</label>
            <input class="compact-batch" type="text" id="batchNumberCompact" placeholder="LANDC....." />
          </div>
          <button id="exportBtnCompact">Export MST Changes</button>
        </div>
      </div>
    </div>

    <div id="calendarEl"></div>
    <div id="mstErrorSummary" class="error-summary">
      <div><strong>MST error checks:</strong></div>
      <div>Upload your MST file and choose a Work Group set to see flagged counts.</div>
    </div>

    <div class="sql-callout">
      <details>
        <summary>SSM's, click here to view SQL Code required for collecting the MSTs for the tool.</summary>
        <p>This should be run weekly and distributed to Planners via your preferred distribution method.</p>
        <pre class="sql-code-block"><code>SELECT
    MSTs.equip_no                                                AS "Equipment Number",
    asset.item_name_1                                            AS "Equipment Description 1",
    asset.equip_status                                           AS "Asset Status Code",

    MSTs.comp_code                                               AS "Component Code",
    cmpcddesc.table_desc                                         AS "Component Description",
    MSTs.comp_mod_code                                           AS "Component Modifier Code",
    cmpmdcddesc.table_desc                                       AS "Component Modifier Description",

    MSTs.maint_sch_task                                          AS "MST Task Number",
    MSTs.job_desc_code                                           AS "Job Description Code",
    jdccode.table_desc                                           AS "Job Description",

    MSTs.sched_desc_1                                            AS "MST Description 1",
    MSTs.sched_desc_2                                            AS "MST Description 2",

    wgset.table_code                                             AS "Work Group Set Code",
    wgset.table_desc                                             AS "Work Group Set Description",

    MSTs.work_group                                              AS "Work Group Code",
    wg.work_grp_desc                                             AS "Work Group Description",

    MSTs.sched_freq_1                                            AS "MST Frequency",
    MSTs.sched_ind_700                                           AS "Scheduling Indicator Code",
    schind.table_desc                                            AS "Scheduling Indicator Desc",

    MSTs.last_sch_date                                           AS "Last Scheduled Date",
    MSTs.last_perf_date                                          AS "Last Performed Date",
    MSTs.next_sch_date                                           AS "Next Scheduled Date",

    MSTs.std_job_no                                              AS "Standard Job Number",
    MSTs.next_sch_ind                                            AS "Next Scheduled Date Indicator",

    MSTs.dstrct_code                                             AS "District Code",
    stdjob.calc_lab_hrs                                          AS "Norm Time",
    ROUND(stdjob.calc_lab_hrs * NVL(MSTs.std_units_required, 1), 2) AS "Resource Hours",

    RTRIM(LTRIM(district.dstrct_name))                           AS "District Name",

    MSTs.assign_person                                           AS "Assigned to Person ID",
    RTRIM(LTRIM(assignto.first_name) || ' ' || RTRIM(assignto.surname))
                                                                 AS "Assigned To Individual Name",

    MSTs.std_units_required                                      AS "Units Required",
    MSTs.sch_seg_fr                                              AS "MST Segment Mileage From",
    MSTs.sch_seg_to                                              AS "MST Segment Mileage To",

    NVL(RTRIM(msttype.property_value), 'false')                  AS "MST Type Code",
    NVL(RTRIM(MSTs.statutory_flg), 'N')                          AS "Statutory Flag",

    NVL(RTRIM(fxsch.fixed_scheduling), 'N')                      AS "Fixed Scheduling",
    NVL(RTRIM(fxsch.allow_multiple), 'N')                        AS "Allow Multiple Work Orders",

    prottypecd.property_value                                    AS "Protection Type Code",
    prottypeds.table_desc                                        AS "Protection Type Description",

    protmethcd.property_value                                    AS "Protection Method Code",
    protmethds.table_desc                                        AS "Protection Method Description",

    tvref.property_value                                         AS "Temp Var Reference Number",
    TO_CHAR(TO_DATE(tvdate.property_value, 'YYYYMMDD'), 'DD/MM/YYYY')
                                                                 AS "Temp Var Expiry Date",

    TRIM(MSTs.equip_no) || TRIM(MSTs.comp_code) || TRIM(MSTs.comp_mod_code) || TRIM(MSTs.maint_sch_task)
                                                                 AS "CONCAT",

    engineer.table_desc                                          AS "Engineer",
    TO_CHAR(SYSDATE, 'DD/MM/YYYY')                               AS "Download Date"
FROM
    msf700 MSTs

    /* Work group */
    LEFT JOIN msf720 wg
        ON wg.work_group = MSTs.work_group

    /* Equipment (single join used for both description + status) */
    LEFT JOIN msf600 asset
        ON asset.equip_no = MSTs.equip_no

    /* Work group set */
    LEFT JOIN msf010 wgset
        ON SUBSTR(wg.work_group_set, 1, 8) = SUBSTR(wgset.table_code, 1, 8)
       AND wgset.table_type = 'WGST'

    /* Engineer */
    LEFT JOIN msf010 engineer
        ON SUBSTR(wgset.assoc_rec, 3, 4) = SUBSTR(engineer.table_code, 1, 4)
       AND engineer.table_type = '+ME '

    /* Delivery Unit ‚Äì changed to INNER JOIN because you filter on it (big speedup) */
    INNER JOIN msf010 delivery_unit
        ON SUBSTR(engineer.assoc_rec, 1, 2) = SUBSTR(delivery_unit.table_code, 1, 2)
       AND delivery_unit.table_type = '+MDU'
       AND delivery_unit.table_desc LIKE '%Lancs%'

    /* Other MSF010 lookups */
    LEFT JOIN msf010 jdccode
        ON MSTs.job_desc_code = SUBSTR(jdccode.table_code, 1, 2)
       AND jdccode.table_type = 'JD  '

    LEFT JOIN msf010 schind
        ON MSTs.sched_ind_700 = SUBSTR(schind.table_code, 1, 1)
       AND schind.table_type = 'MI  '

    LEFT JOIN msf810 assignto
        ON assignto.employee_id = MSTs.assign_person

    LEFT JOIN msf000_dc0001 district
        ON district.dstrct_code = MSTs.dstrct_code

    LEFT JOIN msf010 cmpcddesc
        ON cmpcddesc.table_code = MSTs.comp_code
       AND cmpcddesc.table_type = 'CO  '

    LEFT JOIN msf010 cmpmdcddesc
        ON cmpmdcddesc.table_code = MSTs.comp_mod_code
       AND cmpmdcddesc.table_type = 'MO  '

    /* MST Extended Attributes ‚Äì rewritten to column joins (big speedup) */
    LEFT JOIN mst_extended_attr fxsch
        ON fxsch.equip_no        = MSTs.equip_no
       AND fxsch.maint_sch_task  = MSTs.maint_sch_task
       AND fxsch.comp_code       = MSTs.comp_code
       AND fxsch.comp_mod_code   = MSTs.comp_mod_code

    /* Standard Job */
    LEFT JOIN msf690 stdjob
        ON stdjob.std_job_no  = MSTs.std_job_no
       AND stdjob.dstrct_code = MSTs.dstrct_code

    /* MST Type */
    LEFT JOIN msf0p5 msttype
        ON TRIM(msttype.entity_key) = TRIM(MSTs.equip_no || MSTs.maint_sch_task || MSTs.rec_700_type)
       AND msttype.entity_type = 'MSTService.MST.ZMSTTYPE'

    /* Protection type + method (still SUBSTR-based because entity_key is encoded) */
    LEFT JOIN msf0p5 prottypecd
        ON prottypecd.entity_type = 'MSTService.MST.zProtType'
       AND SUBSTR(RTRIM(prottypecd.entity_key), 1, 4)  = MSTs.comp_code
       AND SUBSTR(RTRIM(prottypecd.entity_key), 5, 2)  = MSTs.comp_mod_code
       AND SUBSTR(RTRIM(prottypecd.entity_key), 7, 12) = MSTs.equip_no
       AND SUBSTR(RTRIM(prottypecd.entity_key), 19, 4) = MSTs.maint_sch_task

    LEFT JOIN msf010 prottypeds
        ON RTRIM(prottypeds.table_code) = RTRIM(prottypecd.property_value)
       AND prottypeds.table_type = 'W8'

    LEFT JOIN msf0p5 protmethcd
        ON protmethcd.entity_type = 'MSTService.MST.zProtMethod'
       AND SUBSTR(RTRIM(protmethcd.entity_key), 1, 4)  = MSTs.comp_code
       AND SUBSTR(RTRIM(protmethcd.entity_key), 5, 2)  = MSTs.comp_mod_code
       AND SUBSTR(RTRIM(protmethcd.entity_key), 7, 12) = MSTs.equip_no
       AND SUBSTR(RTRIM(protmethcd.entity_key), 19, 4) = MSTs.maint_sch_task

    LEFT JOIN msf010 protmethds
        ON RTRIM(protmethds.table_code) = RTRIM(protmethcd.property_value)
       AND protmethds.table_type = 'W9'

    /* Temp Var ref/date */
    LEFT JOIN msf0p5 tvref
        ON tvref.entity_type = 'MSTService.MST.zTVRef'
       AND SUBSTR(RTRIM(tvref.entity_key), 1, 4)   = MSTs.comp_code
       AND SUBSTR(RTRIM(tvref.entity_key), 5, 2)   = MSTs.comp_mod_code
       AND SUBSTR(RTRIM(tvref.entity_key), 7, 12)  = MSTs.equip_no
       AND SUBSTR(RTRIM(tvref.entity_key), 19, 4)  = MSTs.maint_sch_task

    LEFT JOIN msf0p5 tvdate
        ON tvdate.entity_type = 'MSTService.MST.zTVDate'
       AND SUBSTR(RTRIM(tvdate.entity_key), 1, 4)  = MSTs.comp_code
       AND SUBSTR(RTRIM(tvdate.entity_key), 5, 2)  = MSTs.comp_mod_code
       AND SUBSTR(RTRIM(tvdate.entity_key), 7, 12) = MSTs.equip_no
       AND SUBSTR(RTRIM(tvdate.entity_key), 19, 4) = MSTs.maint_sch_task
WHERE
    MSTs.work_group LIKE 'D%' /ADD START OF WORKGROUPS HERE
    AND MSTs.sched_ind_700 = 1</code></pre>
      </details>
    </div>
  </div>
  
  <!-- =========================
       Floating Resource
  ========================== -->
  <div id="resourceFloatPanel">
  <div id="resourceFloatHeader">
    <div>
      <span class="resource-title">Planned Hours (6 weeks)</span>
      <div class="resource-subtitle">based on MST Norm Time x Units Required</div>
    </div>
    <button id="closeResourceFloat">‚úï</button>
  </div>

  <div id="resourceFloatControls">
    <button id="prevWindowBtn">‚óÄ</button>
    <span id="resourceRangeLabel"></span>
    <button id="nextWindowBtn">‚ñ∂</button>
  </div>

  <canvas id="plannedHoursChart"></canvas>
</div>

<!-- =========================
       NEW MST MODAL (Updated)
  ========================== -->
<div id="newMSTModal" style="
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  justify-content:center;
  align-items:center;
  pointer-events:auto;
">
  <div id="newMSTBox" style="
    background:#fff;
    width:75%;
    max-width:900px;
    max-height:90%;
    overflow-y:auto;
    padding:30px;
    border-radius:12px;
    box-shadow:0 4px 20px rgba(0,0,0,0.3);
    pointer-events:auto;
  ">
    <h2 style="text-align:center;">Create New MST</h2>
    <p style="text-align:center;">
      Fields marked <span style="color:red">*</span> are mandatory.
    </p>

  <div id="newMSTForm">
  <!-- Row 1 -->
 <label>
  <span class="label-title">
    Equipment Number <span class="required-star">*</span>
  </span>
  <input id="newEquipNo" required />
  <small id="newEquipDesc" class="muted-helper"></small>
</label>

<label>
   <span class="label-title">
    Standard Job Number <span class="required-star">*</span>
  </span>
    <input id="newStdJobNo" required />
    <small><a href="https://networkrail.sharepoint.com/:x:/r/sites/asd/_layouts/15/Doc.aspx?sourcedoc=%7B62BADB1E-7450-46C4-A0C1-353E38D2AA72%7D&file=Standard%20Job%20List.xls&action=default&mobileredirect=true&DefaultItemOpen=1%3Fweb%3D1" id="stdJobListLink" target="_blank">View Standard Job List</a></small>
  </label>

  <!-- Row 2 -->
 <label>
  <span class="label-title">
    MST Description 1 <span class="required-star">*</span>
  </span>
    <input id="newDesc1" readonly />
  </label>

  <label>MST Description 2
    <input id="newDesc2" maxlength="45" />
    <div class="char-counter" id="newDesc2Counter">0/45</div>
  </label>
  
  <label>
  <span class="label-title">
    WorkGroup <span class="required-star">*</span>
  </span>
    <input id="newWorkGroup" required />
        </label>
  <!-- Row 3 -->
   <label>
  <span class="label-title">
    Job Description Code <span class="required-star">*</span>
  </span>
    <select id="newJobCode" required></select>
  </label>

    <label>
    <span class="label-title">
      Frequency (Days) <span class="required-star">*</span>
    </span>
      <input id="newFreq" type="number" min="1" required />
    </label>

  <!-- Row 4 -->
   <label>
  <span class="label-title">
    Last Scheduled Date <span class="required-star">*</span>
  </span>
    <input id="newLastDate" type="date" required />
  </label>

  <label>
  <span class="label-title">
    Units Required <span class="required-star">*</span>
  </span>
    <input id="newUnits" type="number" required />
  </label>

  <!-- Row 5 -->
  <label>Unit of Measure
    <input id="newUnitMeasure" readonly />
  </label>

  <label>Mileage From
    <input id="newFrom" />
  </label>

  <!-- Row 6 -->
  <label>Mileage To
    <input id="newTo" />
  </label>

  <label>
  <span class="label-title">
    Protection Type <span class="required-star">*</span>
  </span>
    <select id="newProtType" required></select>
  </label>

  <!-- Row 7 -->
   <label>
  <span class="label-title">
    Protection Method <span class="required-star">*</span>
  </span>
    <select id="newProtMethod" required></select>
  </label>

  <label style="display:block;">
    <span class="label-title">Allow multiple Work Orders</span>
    <input id="newAllowMultiple" type="checkbox" />
    <div class="muted-helper" style="margin-top:4px;">
      For &lt;14 Day MSTs and allows the next instance of the MST to be generated before the previous has been closed.
    </div>
  </label>
</div>


    <div style="text-align:center; margin-top:20px;">
      <button id="addMSTBtn" style="background:#10b981;color:white;border:none;padding:8px 20px;border-radius:6px;">
        Add MST
      </button>
      <button id="cancelMSTBtn" style="background:#ef4444;color:white;border:none;padding:8px 20px;border-radius:6px;margin-left:10px;">
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- =========================
     GO TO MST OVERLAY + PANEL
========================== -->
<div id="gotoOverlay">
  <aside id="gotoPanel" aria-label="Go to MST">
    <div id="gotoHeader">
      <h3>Go to MST</h3>
      <button id="closeGotoBtn" title="Close">‚úï</button>
    </div>

    <div id="gotoBody">
      <div class="goto-field">
        <label for="gotoEquip"><strong>Equipment Number</strong></label>
 <input type="text" id="gotoEquip" list="equipList" placeholder="Enter Equipment No" />
<datalist id="equipList"></datalist>

<small id="equipDescPreview" 
       style="display:block; margin-top:4px; font-size:13px; font-weight:bold; color:#333;">
</small>

      </div>
     <div class="goto-field">
        <label for="gotoTask"><strong>Task Number</strong></label>
        <input id="gotoTask" placeholder="e.g. 001" />
      </div>
      <button id="gotoSearchBtn" class="btn-primary" style="margin:8px 0 12px;">Search</button>

      <div id="gotoResults" style="display:none;">
        <table class="goto-table">
          <thead>
            <tr><th>Task No</th><th>MST Description 1</th></tr>
          </thead>
          <tbody id="gotoResultsBody"></tbody>
        </table>
      </div>
    </div>

    <div id="gotoFooter">
      <button id="closeGotoBtn2">Close</button>
    </div>
  </aside>
</div>

  <!-- =======================================================
     WORK GROUP SELECT MODAL (Shown after file upload)
======================================================= -->
<div id="wgSelectModal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:99999;
  justify-content:center; align-items:center; pointer-events:auto;">
  
  <div style="
    background:white; padding:25px; border-radius:10px;
    min-width:420px; max-width:600px; pointer-events:auto;">

    <h3>Select Work Group Set Description</h3>
    <p>Please choose which MST set you want to load into the calendar.</p>

  <select id="wgSelectDropdown" multiple size="8" style="
  width:100%; padding:8px; margin-top:12px; border:1px solid #bbb; border-radius:6px;">
</select>
<p style="font-size:12px; color:#444; margin-top:5px;">
Hold <strong>Ctrl</strong> (or <strong>Cmd</strong> on Mac) to select multiple
</p>

    <label style="display:flex; align-items:center; gap:8px; margin-top:12px; font-size:13px; color:#111827;">
      <input id="wgUseAdditionalFilters" type="checkbox" />
      Use additional filters (Work Group Codes + MST Description 1)
    </label>

    <div style="text-align:right; margin-top:18px;">
      <button id="wgSelectConfirm" style="padding:6px 18px; background:#10b981; color:white; border:none; border-radius:6px;">
        Load MSTs
      </button>
    </div>

  </div>
</div>

  <!-- =======================================================
     INITIAL LOAD FILTER MODAL (Large MST Sets)
======================================================= -->
<div id="initialFilterModal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:99999;
  justify-content:center; align-items:center; pointer-events:auto;">

  <div style="
    background:white; padding:25px; border-radius:10px;
    min-width:420px; max-width:640px; pointer-events:auto;">

    <h3>Additional Filter Required</h3>
    <p id="initialFilterCount">This selection contains a large number of MSTs. Please choose Work Group codes (with descriptions) and one additional filter to continue.</p>

    <label for="initialWorkGroupDropdown" style="display:block; margin-top:14px; font-weight:600;">
      Work Group Codes
    </label>
    <select id="initialWorkGroupDropdown" multiple size="8" style="
      width:100%; padding:8px; margin-top:8px; border:1px solid #bbb; border-radius:6px;">
    </select>
    <p style="font-size:12px; color:#444; margin-top:5px;">
      Hold <strong>Ctrl</strong> (or <strong>Cmd</strong> on Mac) to select multiple
    </p>

    <label for="initialDesc1Dropdown" style="display:block; margin-top:14px; font-weight:600;">
      MST Description 1
    </label>
    <select id="initialDesc1Dropdown" multiple size="8" style="
      width:100%; padding:8px; margin-top:8px; border:1px solid #bbb; border-radius:6px;">
    </select>
    <p style="font-size:12px; color:#444; margin-top:5px;">
      Counts are shown per MST Description 1. Select one or more to load a smaller MST set.
    </p>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:18px;">
      <button id="initialFilterBack" style="padding:6px 18px; background:#e5e7eb; color:#111827; border:none; border-radius:6px;">
        Back
      </button>
      <button id="initialFilterConfirm" style="padding:6px 18px; background:#10b981; color:white; border:none; border-radius:6px;">
        Load MSTs
      </button>
    </div>

  </div>
</div>

  <!-- =========================
       PAGE SCRIPT
  ========================== -->
  <script src="libs/Resources.js"></script>
  <script src="libs/MST-views.js"></script>
  <script>
    /******************************************************************
     * STATE
     ******************************************************************/

    window.futureEventsMap = {};  // mstId -> [EventApi, EventApi]
    window.originalProps   = {};  // mstId -> source row (snapshot)
    window.changes            = {};  // mstId -> export deltas
    window.originalRows       = [];  // raw uploaded rows

// ================================
// HEADER COLLAPSE TOGGLE + COMPACT CONTROLS
// ================================
const pageHeader      = document.querySelector(".page-header");
const toggleHeaderBtn = document.getElementById("toggleHeaderBtn");
const actionBar       = document.getElementById("controls");
const compactControls = document.getElementById("collapsedHeaderControls");
const batchNumber     = document.getElementById("batchNumber");
const batchNumberCompact = document.getElementById("batchNumberCompact");

const syncBatchToCompact = () => {
  if (batchNumber && batchNumberCompact) {
    batchNumberCompact.value = batchNumber.value;
  }
};

const syncBatchToPrimary = () => {
  if (batchNumber && batchNumberCompact) {
    batchNumber.value = batchNumberCompact.value;
  }
};

if (batchNumber && batchNumberCompact) {
  batchNumber.addEventListener("input", syncBatchToCompact);
  batchNumberCompact.addEventListener("input", syncBatchToPrimary);
  syncBatchToCompact();
}

if (pageHeader && toggleHeaderBtn) {
  const updateToggleLabel = (collapsed) => {
    toggleHeaderBtn.setAttribute("aria-expanded", String(!collapsed));
    toggleHeaderBtn.innerHTML = collapsed
      ? 'Show instructions <span aria-hidden="true">‚ñº</span>'
      : 'Hide instructions <span aria-hidden="true">‚ñ≤</span>';
  };

  const setCollapsedState = (collapsed) => {
    pageHeader.classList.toggle("collapsed", collapsed);
    updateToggleLabel(collapsed);
    if (actionBar) actionBar.classList.toggle("header-collapsed", collapsed);
    if (compactControls) compactControls.style.display = collapsed ? "flex" : "none";
    if (collapsed) syncBatchToCompact();
  };

  setCollapsedState(pageHeader.classList.contains("collapsed"));

  toggleHeaderBtn.addEventListener("click", () => {
    const collapsed = !pageHeader.classList.contains("collapsed");
    setCollapsedState(collapsed);
  });
}

// ================================
// NEW MST MODAL LOGIC
// ================================

const newMSTModal    = document.getElementById("newMSTModal");
const addMSTBtn      = document.getElementById("addMSTBtn");
const cancelMSTBtn   = document.getElementById("cancelMSTBtn");

// Add MST
if (addMSTBtn) addMSTBtn.addEventListener("click", () => MST.Editor.addNewMST());
if (cancelMSTBtn) cancelMSTBtn.addEventListener("click", () => MST.Editor.closeNewMSTModal());

document.getElementById("newMSTBtn")?.addEventListener("click", () => MST.Editor.openNewMSTModal());

  </script>


</body>
</html>
